
# 库存

## 业务背景
商店的库存对零售店的盈利有巨大的影响，零售店的管理人员需要确保正确的产品处于正确的商店中，尽量减少出现产品脱销的情况，并且减少总的库存管理成本。因此零售商想通过产品和商店来分析商品的库存情况。  

## 三个事实表
根据上面的场景，我们为了库存业务分别为建商店、仓库、仓库产品建立了三个事实表

### 商品库存周期快照事实表
还是按照维度建模的四步骤走：
1. 选定业务过程：选定的业务过程是操作型系统的当天的零售商店库存快照。  
2. 选择粒度：根据上面选择的业务过程，我们定义的事实表原子粒度是每家商店中每种商品的日库存。
3. 确定维度：确定的维度有：日期、产品、商店。上一章中包含的促销维度、店员维度等不是库存产生的描述性环境信息，因此上一章中的这些维度会在本库存案例中剔除
4. 确定事实：最简单的事实表中只有一个事实：当天库存数量。但是仅有库存数量，对于库存分析来说不够充分，我们还可再事实表中存入当天销售数量，当天库存成本，以商品最新售价计算得到的当天库存产品总价值  

#### 事实表结构
![](./img/dimensional/%E5%BA%93%E5%AD%98%E5%91%A8%E6%9C%9F%E5%BF%AB%E7%85%A7.png)  
在这个事实表中：  
当天库存数量、当天库存产品总价值属于半可加事实，仅能按照产品或者商店维度进行汇总，不能按照日期进行汇总；  
当天销售数量、当天库存成本则属于完全可加事实


### 仓库库存事务事实表
第二个事实表是为仓库建立的，用于记录每次影响到仓库库存的事务。
一个仓库的操作型系统会影响到库存的事物可能包含以下几项：  
![](./img/dimensional/%E5%BD%B1%E5%93%8D%E5%BA%93%E5%AD%98%E7%9A%84%E4%BA%8B%E5%8A%A1.png)  

1. 选定业务过程：操作型系统中会影响到仓库库存的每个事务
2. 选择粒度：库存事务
3. 确定维度：日期、产品、仓库、事务类型  
  确定维度这一块，每种操作型事务都会有的维度：日期、产品、仓库、事务类型（接收产品、放入检验区、产品入库等）；  
  而有一些维度比如：托运人、客户可能只在产品出库的事务中才有，在入库前的事务中则没有，这些维度没有被纳入这个事实表中。原因是如果事实有不同的维度，应当要建立不同的事实表，而不是强行放在同一个事实表中，比如为出库后的事务再额外建立一张仓库出库事实表，这个事实表中就可以有客户维度。  
4. 确定事实：产品金额  
  这个事实会在所有仓库事务中存在  

#### 事实表结构
![](./img/dimensional/%E4%BB%93%E5%BA%93%E5%BA%93%E5%AD%98%E4%BA%8B%E5%8A%A1%E4%BA%8B%E5%AE%9E%E8%A1%A8.png)  

这个事实表中反应了每个库存操作的信息，可以方便的分析发生在某些时间特别频繁发生的事务操作等。此事实表可以用来回答仓库库存周期事实表不能回答的细节问题：比如哪天产品入库的操作最多。  
虽然理论上可以通过回滚此事务事实表来回到某一时刻的仓库库存情况，并通过事务类型来获取到仓库某天的某产品的情况，但是实现起来很困难而且性能极差，因此实际使用中如果要分析仓库每天的库存情况，我们可能还是需要建立一张仓库库存周期快照事实表


### 仓库收据累积快照事实表  
第三张事实表是为仓库收据建立，用于跟踪一个批次内的产品在仓库内完整的生命周期：从入库到离开仓库。  
1. 选定业务过程：仓库收据相关事件  
2. 选择粒度：单个仓库收据  
3. 确定维度：仓库收据的几个关键日期维度：接收日期、验收日期、入库日期、初始装运日期、最终装运日期以及产品维度、仓库维度、供应商维度  
4. 确定事实：仓库收据内的事实有  
收到的产品数量、检验合格的产品数量、退回的产品数量、存入到仓库的产品数量、发给客户的产品数量、客户退回的产品数量、退回后存入仓库的产品数量、损坏的产品数量、  
接收日期到验收日期的延迟天数、接收到入库的延迟天数、入库到初始装运延迟的天数、初始装运到最终装运延迟的天数  

#### 事实表结构  
![](./img/dimensional/%E4%BB%93%E5%BA%93%E5%BA%93%E5%AD%98%E6%94%B6%E6%8D%AE%E4%BA%8B%E5%AE%9E%E8%A1%A8.png)  

#### 事实表样例
![](./img/dimensional/%E4%BB%93%E5%BA%93%E6%94%B6%E6%8D%AE%E4%BA%8B%E5%AE%9E%E8%A1%A8%E6%BC%94%E8%BF%9B.png)  

在这个事实表的每一行的可以一直更新，直到这个批次接收到的产品从仓库中完全耗尽并且客户没有退货。拥有这个事实表后我们可以很方便的跟踪一个批次内的产品，并且事实表提供了一些关键日期的延迟天数，可以方便的回答仓库的运转效率如何的问题

### 三种类型的事实表对比

![](./img/dimensional/%E4%B8%89%E7%A7%8D%E7%B1%BB%E5%9E%8B%E7%9A%84%E4%BA%8B%E5%AE%9E%E8%A1%A8%E5%AF%B9%E6%AF%94.png)  

图中的累积快照事实表中的管道事件是影响累积快照事实表一行记录的一系列事件。



# 企业数据仓库总线架构  
企业数据仓库总线架构是维度建模的三大核心之一（另外两个是一致性维度、一致性事实）  
总线是指在计算机组件间用来规范化交换数据的一种方式，具体的交换数据方式就是所有的计算机组件都连接到一条数据线中，通过这一条数据线来交换数据，这一条数据线就是总线。对应到数据仓库中，一致性维度与一致性事实就是像这个总线，数据仓库内数据集市则像计算机内各个组件，不同的数据集市通过一致性维度、一致性事实这一总线进行交互分析。这一个数据集市交互的方式就是企业数据仓库总线架构  


- 数据集市：
指数据仓库内的物理上的各个不同业务的数据库表

- 一致性事实：  
如果一个事实在多个事实表中出现，并且针对的都是同一个业务，那么这些事实表中的这个事实含义、命名、度量单位必须相同，并且事实的单位也要相同。比如：两个事实表中都出现了下单金额这一事实，并且这个事实都来自于订单创建事件，那么这两个事实表中的下单金额的字段名、真实含义都应该是相同的、度量单位也应该一样，不能一个是以元作为单位、一个以分作为单位。  
![](./img/dimensional/%E4%BD%BF%E7%94%A8%E4%BC%81%E4%B8%9A%E4%BB%93%E5%BA%93%E6%80%BB%E7%BA%BF%E6%9E%B6%E6%9E%84%E7%9A%84%E6%A0%B7%E4%BE%8B.png)


## 企业数据仓库总线矩阵
通常情况下，可以用矩阵文档的方式来描述企业的数据仓库总线。比如：  
![](./img/dimensional/%E4%BC%81%E4%B8%9A%E6%95%B0%E6%8D%AE%E4%BB%93%E5%BA%93%E6%80%BB%E7%BA%BF%E7%9F%A9%E9%98%B5%E6%A0%B7%E4%BE%8B.png)  
矩阵的第一行的横轴表示企业数据仓库内存在的一致性维度
矩阵中第一列纵轴表示企业的业务过程  
矩阵中交叉的地方则表示该业务过程是否含有此维度，标有X表示该业务含有此维度  

## 总线架构使用样例
如果每个数据集市都加入到企业数据仓库总线的中，那么就可以很容易的用一致性维度进行跨事实表的数据分析。  
比如要获取一个产品的订单数量、库存数量、销售数量，在企业数据仓库总线中简单的使用join查询订单事实表、库存事实表、销售事实表就可以获得要的结果  
![](./img/dimensional/%E4%B8%80%E8%87%B4%E6%80%A7%E7%BB%B4%E5%BA%A6%E8%B7%A8%E4%BA%8B%E5%AE%9E%E8%A1%A8%E8%8E%B7%E5%8F%96%E6%95%B0%E6%8D%AE.png)


# 小结
这一章中前半部分通过库存这一业务场景，来介绍三种类型的事实表。后半部分则介绍企业数据仓库总线架构。


# 采购

## 业务背景
对于许多公司来说，采购是一项关键的业务。采购就是用最经济的方式来得到适当的产品，采购涉及到的事务有：签订合同、发起购买订单、跟踪票据、授权付款。公司的采购部门想知道最常采购的产品是什么、有多少供应商提供过这些产品、提供时的价格是多少、供应商能按时交货吗、延迟交货情况是怎么样、收到的产品校验通过率怎么样？等等一系列和采购有关的需求  
## 采购的维度建模四步骤
1. 选择业务过程：设计到的采购事务有：采购请求、采购订单、托运通知、仓库收货、付款、开发票
2. 选择粒度：单个采购事务为一行，建立事务事实表

### 单事务事实表与多个事务事实表的选择
在维度建模第2个步骤中，我们还存在一个问题：是将不同的事务放在同一个事务表中，还是为不同的事务建立不同的事务表？  
涉及到影响选择的因素
1. 我们选择的业务过程：购买清单、购买订单、货运通知等来自不同的操作型系统，比如购买系统负责提供购买清单和购买订单，仓库系统提供发货通知  
2. 不同的事务中有独特意义的号码，比如采购订单中的订单号、付款事务中的付款单号，这些事务号码可以是含义不同的退化维度
3. 不同的事务中具有不同的维度，比如在购买清单中有没有运输公司维度、到了购买订单事务中才确定了运输公司

面对上面的问题，要选择建立单事务事实表或者多事务事实表有以下几种对策：
1. 用户的分析需求是什么？我们的目标是用最有效的方式给商业用户展现数据，我们应当采用能最自然的和他们的业务期望符合的方式  
2. 的确存在多个独特的业务过程吗？判断一个业务是不是独特的业务，有一个方法就是观察事务号码的含义是否相同，如果事务号码的含义不同，应该趋向于建立不同的事实表  
3. 事务是否来自同一个源系统、粒度是否一致？在这个案例中，事务来自三个不同的源系统：购买系统、仓库系统、付款系统，这种情况下应当建立不同的事实表  
4. 事实的维度是否相同？ 在这个案例中，一些事实的维度在另一些事务中不存在，这种情况下应当建立不同的事实表。

基于上面的对策，我们选择建立多个事务事实表，主要原因有： 
1. 事务数据来自不同的原系统
2. 不同的事务有特定的维度  
3. 多个事务事实表可以更具体的描述事实产生的维度，如果我们建立的是多个事务事实表，那么对于购买订单日期、收货日期我们可以直接在事实表中建立对应的字段，而单一事实表可能要抽象为事务时间。并且多个事务事实表可以拥有各自独特的维度

#### 事实表结构   
![](./img/dimensional/%E9%87%87%E8%B4%AD%E4%B8%9A%E5%8A%A1%E7%9A%84%E5%A4%9A%E4%B8%AA%E4%BA%8B%E5%AE%9E%E8%A1%A8.png)

### 采购累计快照事实表  
除了上面的多事务事实表，为了让采购部门能更好的监督采购活动的进展，在这个案例中我们还建立了一张跨业务过程的采购累计快照事实表。累计快照事实表适合一个有生命周期的一系列事务，如果一些事务是不断产生、没有终止的话可能不适合建立累计快照事实表
#### 事实表结构
![](./img/dimensional/%E9%87%87%E8%B4%AD%E7%B4%AF%E8%AE%A1%E5%BF%AB%E7%85%A7%E4%BA%8B%E5%AE%9E%E8%A1%A8.png)


# 缓慢变化维度处理详细
缓慢变化维（Slowly Changing Dimension,SCD）是指会维度属性会发生变化的维度，下面介绍如何处理缓慢变化维

## 类型0：保留原始值
将维度的变化丢弃，保留原值。这种方式适合处理维度中一旦存在就不会改变的值。比如原始用户信息积分、快照型属性


## 类型1：重写
用新值覆盖旧值。这种方式实现简单，但是如果需要分析数据的历史变化情况，那么这种方式就不适合使用，原有是会丢失原有数据。  
![](./img/dimensional/%E7%B1%BB%E5%9E%8B1.png)

## 类型2：增加新行
通过增加新的行来处理维度的变化。新插入一行维度来处理维度属性的变化，并将旧的维度设置为失效；后续事实表插入记录关联的都是新的维度行。
![](./img/dimensional/%E7%B1%BB%E5%9E%8B2.png)

## 类型3：增加新属性
通过增加新的属性来处理维度表属性的变化。维度表属性变化时，将新的属性值保存在新增的属性中，不影响旧的属性。  
- 使用样例
![](./img/dimensional/%E7%B1%BB%E5%9E%8B3.png)
- 多个类型3属性  
![](./img/dimensional/%E5%A4%9A%E7%B1%BB%E5%9E%8B3.png)  

类型3如果要保留属性的多次变化，需要增加多个列，如果一个维度表有50列，那么如果每个属性只保留一次变化，那么维度表就变成了100行，如果还想保留多次变化那维度表就会变得更加庞大，这对维度表的可读性、存储代价、查询性能都有坏处，通常应该避免使用类型3，除非有特定的需求场景。

### 类型3独有的能处理场景
类型3与类型2相比，虽然增加新属性来处理维度变化对表结构影响更大，拓展起来更麻烦，但是类型3独有的特点是是能够让分析人员即能通过旧的属性来分析全局数据、又可以用新的属性来分析数据。  
比如一家公司的销售人员维度中的部门是按照销售负责区域来划分的  
![](./img/dimensional/%E7%B1%BB%E5%9E%8B3%E4%BE%8B%E5%AD%901.png)  
有一天管理层突然决定把销售部门负责的区域更精细化，把部门销售地区北部与南部细分为东北区、东南区  
![](./img/dimensional/%E7%B1%BB%E5%9E%8B3%E4%BE%8B%E5%AD%902.png)  
由于发生的比较仓储，数据分析人员希望在接下来几个月的过渡期希望即能按照旧的销售区分来分析数据，又能按照新的销售区域来分析。  
这种情况类型1和类型2，都无法处理：  
类型1直接丢失了原来的部门销售区域，不能按照旧的销售区域来分析  
类型2中事实表一半数据是旧的部门销售区、一半是新的部门销售区域。数据分析人员即不能按照新的销售区域来分析所有数据，也不能按照旧的销售区域分析所有数据  
而类型三，维度表种即保留了原来的销售区域又有新的销售区域，只有它能满足这种场景。  
![](./img/dimensional/%E7%B1%BB%E5%9E%8B3%E4%BE%8B%E5%AD%903.png)

## 类型4：增加微型维度
对于维度变化频率非常快，并且维度表数据量很大有几百万行的情况下，我们可以建立一个新的包含多个维度属性值范围的维度表来降低维度变化的频率  
- 微型维度表  
![](./img/dimensional/%E5%BE%AE%E5%9E%8B%E7%BB%B4%E5%BA%A6%E8%A1%A8.png)  
  微型维度表由各个维度属性值的笛卡尔积组成，我们可以事先预测到能组成的笛卡尔来提前建立微型维度表。
- 采用微型维度表的事实表  
![](./img//dimensional/%E5%BE%AE%E5%9E%8B%E7%BB%B4%E5%BA%A6%E8%A1%A82.png)  
微型维度和维度表通过事实表相连，并不直接连接  

由于微型维度表丢失了数据的准确值，如果需要准确值，我们可以考虑使用无事实的事实表来额外记录。比如雇员变化的无事实事实表，将雇员当时的准确年龄、薪资关联到准确的维度表中。

## 混合处理缓慢变化维

### 类型5：微型维度+类型1
类型5将微型维度和类型1组合一起使用。在主维度表中关联微型维度表，同时事实表又与微型维度关联  
![](./img/dimensional/%E7%B1%BB%E5%9E%8B5.png)  
这样做的好处：  
- 雇员维度对雇员的描述更加详细，并降低了雇员维度表的变化频率
- 如果需要分析数据的历史变化，可以通过与事实表直接关联的微型维度来分析
- 如果要用当前属性值来分析，可以通过与事实表关联的当前雇员维度来分析

### 类型6：类型1+类型2+类型3
类型6是将类型1、类型2、类型3混合使用，这种方式的使用场景是既想按照维度的最新值来分析历史数据又想保留数据的历史变化。  
![](./img/dimensional/%E7%B1%BB%E5%9E%8B6%E4%BE%8B%E5%AD%90.png)
- 类型6的详细处理步骤：
1. 为需要这样处理的维度属性创建previous和current两列
2. 以类型2的方式插入新行，同时将此维度所有行的current更新为最新值

- 如果要以当前值来分析数据那么可以使用current列来分析
- 如果要分析历史数据那么可以使用previous列来分析


### 类型7：双重类型1与类型2
类型6因为使用了类型3因此带上类型3的弊端，维度表中需要增加额外的列来保存最近一次属性的变化，如果维度表有150个列，那么使用了类型6的维度表就会额外增加150列。类型7算是类型6的一个优化的处理方式，类型7的使用场景和类型6一致，都是既想按照维度的最新值来分析历史数据又想保留数据的历史变化。
类型7的处理方式：
1. 对于同一个维度，我们建立两张维度表。一张维度表用类型1来处理，保留当前维度的最新状态；另一张维度表用类型2来处理，保留维度的历史变化。
2. 在事实表中对于这个维度有两个关联外键，一个外键关联类型1处理的维度表，另一个外键关联类型2处理的维度表  
- 类型7例子：
![](./img/dimensional/%E7%B1%BB%E5%9E%8B7.png)

类型7的维度表数据分析方式：
- 如果要以维度当状态来分析数据则事实表关联的使用最新维度表
- 如果要以维度历史变化状态来分析数据则使用事实表关联的事实产生时的记录维度表

## 缓慢变化维总结
![](./img/dimensional/%E7%BC%93%E6%85%A2%E5%8F%98%E5%8C%96%E7%BB%B4%E6%80%BB%E7%BB%93.png)

# 第六章小结
这一章上半部分介绍了采购业务的案例，下半部分则比较详细的介绍了缓慢变化维的处理方式


