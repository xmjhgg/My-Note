# 维度建模简介
维度建模是一种数据仓库建立数据模型的指导方法。维度建模以分析决策的需求来构建数据模型，重点解决用户快速完成分析数据的需求并且同时还有较好的大规模复杂查询的响应性能。  
主要的两个优势：  
- 数据仓库的使用者容易理解通过维度建模发布出来的数据  
- 提供高效的查询性能  

在维度建模中使用事实表和维度表来构建数据仓库

# 维度建模中的基本概念介绍
维度建模中最重要的两个概念：事实与维度，围绕这两个概念衍生出了事实表、维度表等等，下面介绍以下维度建模中的几个基本概念

## 事实
事实这一术语表示某个业务过程的数字型的度量值。  
比如在零售店里，店员销售商品这一个业务，这个销售业务中的销售额就是事实，这个事实可以通过店员扫商品条形码时获得。
![](./img/dimensional/%E4%B8%9A%E5%8A%A1%E8%BD%AC%E6%8D%A2%E4%B8%BA%E4%BA%8B%E5%AE%9E.png)

## 事实表
维度模型中的事实表用来存储度量事件的度量结果以及与这个度量事件有关的维度表外键。
| （度量事件可以理解成业务过程产生的业务事件）

事实表中的每行记录对应一个（或者多个）业务过程产生的度量事件。比如上图中的零售事实表，其中的每一行就对应了一个销售事件，并且在事实表中存储了这次事件中的事实（销售美元金额）  

### 三种粒度级别的事实表
事实表中每行是一个特定粒度级别的数据，按照事实表每行数据粒度的不同，事实表可以分为三种类型：
#### 事务事实表  
事务事实表中的一行记录对应一个度量事件，粒度是原子级别。
比如业务过程中发生了订单的创建事件、订单付款事件；那么事务事实表中就会一个处理创建状态的订单和一个处于已付款状态的订单

#### 周期快照事实表
周期快照事实表中的一行记录汇总了发生在某一个周期的度量事件。粒度是某个时间周期。如某一天、某一周、某月的所有度量事件，这一类事实表通常存储有按照时间汇总需求的事实。  
比如当天销售额快照、当天库存快照等。

#### 累积快照事实表
累计快照事实表的一行记录对应了某个业务下的一个事务或者产品的整个生命周期的事件。粒度是一个事务的完整生命周期。这一类事务表中通常会有多个时间字段来记录事务生命周期的关键时间  
比如一个订单累计快照事实表，表中的每一行就是一个订单，每一行汇聚了这个订单的所有事件，行内的数据会有订单的付款事件、发货时间、交易完成时间等订单生命周期内的关键时间。


### 无事实的事实表
有一些业务产生的事件中没有数字型的度量值，也就是事件中不含有事实，但是这个事件对于分析决策也很有作用，也应当为这类事件建立一个事实表，这种不包含事实的事实表称为无事实的事实表。
比如一个用户点击商品事件，事件内容只有用户在什么时间点击了什么商品，虽然事件内没有数字型的度量值，但是可以帮助分析用户对商品的喜好和最近的购买需求，这类事件也值得建立事实表。

### 聚集事实表
聚集事实表是在原子粒度的事实表上进行简单的数字度量值的上卷操作，目的是提高查询的性能。  
- 上卷：  
进行数据汇总聚合，维度由细变粗。比如原来是观察每日的销售情况，调整到观察每月的销售情况
- 下钻：
把数据拆分到更细的粒度，维度由粗变细。是上卷的逆向操作。  

比如订单事实表的粒度是单个订单，现在有一个需求是分析每个商家的订单交易情况，这时候我们可以将订单表事实表中的事实按照商家进行汇总得到一个订单聚集事实表，方便后续的分析

### 合并事实表
合并事实表是将来自多个业务过程、粒度相同的事实合并成一个单一的事实表，合并事实表应用场景是经常需要共同分析的多个业务度量值。  
比如我们有一个发货事实表、交易事实表，我们想分析发货时间对于订单交易完成的影响，那么此时就可以将发货事实表和交易事实合并成一个事实表，更方便分析。
### 以上几种类型事实表的关系
上面的几种事实表是对事实表的分类命名，但是对于一张事实表而言除了根据粒度分类的事实表，上面几种类型的事实表不是互斥的，一张事实表可能即是事务事实表又是无事实的事实表，但不可能即使是事务事实表又是周期快照事实表

## 维度
维度是用来表达事件中事实产生的上下文环境。用于描述“谁、在哪、什么时候、如何、为什么”之类的事件背景。
比如还是上面的零售店内店员销售商品事件，其中销售额属于事实，那么销售额产生的环境：谁卖的：店员的员工工号、谁买的：顾客的姓名、在哪个店买的：零售店的名字、什么时候买的：顾客购买的时间，这些就是维度

### 如何区分事实与维度
通常情况可以用下面这个办法来简单的确定事件中的事实与维度
事实通常是数字型，事实对应的业务属性会有包含动词，比如销售金额、下单商品数量、付款金额等
维度通常是文本型，业务事件内的属性通常是一个名词，比如买家id、商品id等

## 维度表
维度表是事实表不可或缺的组成部分，维度表中存储的便是事件中事实发生的环境，也就是维度

## 维度表结构
每个维度表都包含单一的主键。维度表的主键是作为与之关联的事实表发生环境的外键。
维度表通常比较宽，是扁平化的反范式表，包含大量的低粒度的文本属性。  
维度表的属性是BI应用查询条件和分组的主要目标。

## 维度表主键的选择：自然键与代理键
### 自然键
自然键是指在进入数据仓库之前，已经真实存在的主键  
比如：操作型系统传来的商品ID、用户ID
### 代理键
代理键是指不是由操作型系统传来的主键，而是数据仓库系统自己生成的主键，代理键只有一个用途：关联事实表和维度表 
### 维度表应当使用哪种主键
更推荐维度表使用代理键来作为主键，而不是操作型系统传来的主键，主要理由有两个:  
1. 数据仓库的数据源有多个，如果采用操作型系统传来的主键，某些时候可能会发生主键重复的问题  
2. 代理键的存在可以用来处理当维度表内的数据发生变化时，可以通过新增维度记录的方式来改变事实表记录的维度从而不删除变化前的维度记录

## 为什么建议维度表使用反范式
使用第三范式来进行表设计的主要目的是减少数据的冗余，但是和事实表相比，维度表的数据会少得多，所以可以接受用冗余部分速度的代价换来好的查询性能以及更容易理解维度表，而不需要一次次的join才能理解一个维度表。这正好对应了维度建模的目标：简化和速度。所以对于维度表而言，使用反范式来扁平化维度可以使BI开发人员看表时更容易理解维度表，并且减少维度表之间的jion，提高性能。

## 退化维度
有时候，维度除了一个主键以外没有其他的内容，对于这种维度没必要额外建立一个维度表，而是退化到存储在事实表中，这个维度就是退化维度。  
比如对于订单事实表中的订单号这个维度，订单号是一个维度，经常作为一个查询条件，但是订单号这个维度只有订单号这个属性，我们就会将其直接存到事实表中，订单号就是一个退化维度。

## 如何处理维度表的变化
维度表并不是存储后一直不变的，那么当维度表内数据要发生变化时该如何处理
### 处理方式0：原样保留
原样保留就是当维度属性有新值时，直接丢弃，不进行处理  
这种方式通常用于要保留快照类型的维度属性
比如：用户维度表中，有一个属性是用户初始名，当这个属性要变化时，这个变化会被丢弃，维度表不发生任何改动  
### 处理方式1：重写
重写就是用新值覆盖到旧值。  
这种处理方式很简单，但是有一个使用前提，就是不关心数据的历史变化情况，因为这种方式会导致原值丢失，无法再获取到原来的数据是什么
### 处理方式2：增加新行
这种处理方式就是通过新增一行更新后数据来替代原来的旧数据  
这种处理方式需要维度表采用代理键的形式，以及维度表的行能表示当前行的有效时间。这样有新的事件发生时，事实表中记录的关联维度就可以根据事件发生的时间来关联新增维度的代理键（如果用自然键，所有事实表关联的维度表主键都是是一样的，无法区分真正关联的是什么时候的维度），事实表中旧的数据不受到维度更新的影响  

详细的处理方式：
1. 维度表行中增加 三个额外列 ：1：行有效的开始时间 2、行过期时间 3：当前行是否生效
2. 最初插入的维度记录中设置 1.行有效的开始时间就是插入时间 2.行过期时间用某个遥远日期表示不会过期 3.当前行有效
3. 当维度表发生变化时：  
  1. 上一条记录的过期时间更新为当前时间并改为失效
  2. 新增一条维度并设置 1.行有效时间为当前 2.行过期时间为不会过期 3.当前行有效
4. 后续事实表中插入的记录关联的就是新增的维度的代理键

![](./img/dimensional/%E7%BB%B4%E5%BA%A6%E5%8F%98%E5%8C%96%E7%9A%84%E5%A4%84%E7%90%86-%E7%B1%BB%E5%9E%8B2.png)


# 维度模型
## 星型模型  
星型模型是将事实表作为中心，事实表中只存储事实，相关的维度用关联的方式去关联维度表,维度表以扁平化的形式设计  
![](./img/dimensional/%E6%98%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F.png)
## 雪花模型  
雪花模型也是将事实表作为中心，但是维度表则是以遵守第三范式的基础上进行设计，使得维度表看上去像雪花一样，我们应当尽量避免出现雪花模型，扁平化处理维度表。  
![](./img/dimensional/%E9%9B%AA%E8%8A%B1%E6%A8%A1%E5%9E%8B.png)
## 星座模型
星座模型是指随着星型模型的发展，维度表不只关联了一个事实表，被多个事实表贡献，使得表与表之间看起来像一个又一个的星座，星型模型必然会演化成星座模型
![](./img/dimensional/%E6%98%9F%E5%BA%A7%E6%A8%A1%E5%9E%8B.png)

# 维度建模4步骤
## 选择业务过程
## 声明粒度
## 确定维度
## 确定事实 


# 维度建模例子-零售商店



## 业务场景

## 事实划分

## 建立事实表

## 建立维度表

| 参考资料:  
|  《数据仓库工具箱》 1-3章