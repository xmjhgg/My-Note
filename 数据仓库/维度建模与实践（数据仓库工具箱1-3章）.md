# 维度建模简介
维度建模是一种数据仓库建立数据模型的指导方法。维度建模以分析决策的需求来构建数据模型，重点解决用户快速完成分析数据的需求并且同时还有较好的大规模复杂查询的响应性能。  
主要的两个优势：  
- 数据仓库的使用者容易理解通过维度建模发布出来的数据  
- 提供高效的查询性能  

在维度建模中使用事实表和维度表来构建数据仓库

# 维度建模中的基本概念介绍
维度建模中最重要的两个概念：事实与维度，围绕这两个概念衍生出了事实表、维度表等等，下面介绍以下维度建模中的几个基本概念

## 事实
事实这一术语表示某个业务过程的数字型的度量值。  
比如在零售店里，店员销售商品这一个业务，这个销售业务中的销售额就是事实，这个事实可以通过店员扫商品条形码时获得。
![](./img/dimensional/%E4%B8%9A%E5%8A%A1%E8%BD%AC%E6%8D%A2%E4%B8%BA%E4%BA%8B%E5%AE%9E.png)

### 事实的分类
按照事实是否可以在某些维度下是否累加分为以下三类事实
- 可加事实  
可加事实指的是该度量可以按照和事实表关联的任一维度进行汇总，比如每天新增人口数，这个事实可以基于各个关联的维度汇总  
- 半可加事实  
半可加事实指的就是该度量在某些维度下不可进行汇总，或者说汇总起来没有意义
比如用户账户余额 是典型的半可加型事实，只有在用户维度下相加，得出的所有用户余额总额这个数字是有意义的，其他维度下相加是没有意义的。  
- 不可加事实  
不可加事实指的是该度量在所有与该事实表关联的维度下都不可进行累加汇总，比如男女性别比例  

## 事实表
维度模型中的事实表用来存储度量事件的度量结果以及与这个度量事件有关的维度表外键。
（度量事件可以理解成业务过程产生的业务事件）

事实表中的每行记录对应一个（或者多个）业务过程产生的度量事件。比如上图中的零售事实表，其中的每一行就对应了一个销售事件，并且在事实表中存储了这次事件中的事实（销售美元金额）  

### 三种粒度级别的事实表
事实表中每行是一个特定粒度级别的数据，按照事实表每行数据粒度的不同，事实表可以分为三种类型：
#### 事务事实表  
事务事实表中的一行记录对应一个度量事件，粒度是原子级别。
比如业务过程中发生了订单的创建事件、订单付款事件；那么事务事实表中就会一个处理创建状态的订单和一个处于已付款状态的订单

#### 周期快照事实表
周期快照事实表中的一行记录汇总了发生在某一个周期的度量事件。粒度是某个时间周期。如某一天、某一周、某月的所有度量事件，这一类事实表通常存储有按照时间汇总需求的事实。  
比如当天销售额快照、当天库存快照等。

#### 累积快照事实表
累计快照事实表的一行记录对应了某个业务下的一个事务或者产品的整个生命周期的事件。粒度是一个事务的完整生命周期。这一类事务表中通常会有多个时间字段来记录事务生命周期的关键时间  
比如一个订单累计快照事实表，表中的每一行就是一个订单，每一行汇聚了这个订单的所有事件，行内的数据会有订单的付款事件、发货时间、交易完成时间等订单生命周期内的关键时间。


### 无事实的事实表
有一些业务产生的事件中没有数字型的度量值，也就是事件中不含有事实，但是这个事件对于分析决策也很有作用，也应当为这类事件建立一个事实表，这种不包含事实的事实表称为无事实的事实表。
比如一个用户点击商品事件，事件内容只有用户在什么时间点击了什么商品，虽然事件内没有数字型的度量值，但是可以帮助分析用户对商品的喜好和最近的购买需求，这类事件也值得建立事实表。

### 聚集事实表
聚集事实表是在原子粒度的事实表上进行简单的数字度量值的上卷操作，目的是提高查询的性能。  
- 上卷：  
进行数据汇总聚合，维度由细变粗。比如原来是观察每日的销售情况，调整到观察每月的销售情况
- 下钻：
把数据拆分到更细的粒度，维度由粗变细。是上卷的逆向操作。  

比如订单事实表的粒度是单个订单，现在有一个需求是分析每个商家的订单交易情况，这时候我们可以将订单表事实表中的事实按照商家进行汇总得到一个订单聚集事实表，方便后续的分析

### 合并事实表
合并事实表是将来自多个业务过程、粒度相同的事实合并成一个单一的事实表，合并事实表应用场景是经常需要共同分析的多个业务度量值。  
比如我们有一个发货事实表、交易事实表，我们想分析发货时间对于订单交易完成的影响，那么此时就可以将发货事实表和交易事实合并成一个事实表，更方便分析。
### 以上几种类型事实表的关系
上面的几种事实表是对事实表的分类命名，但是对于一张事实表而言除了根据粒度分类的事实表，上面几种类型的事实表不是互斥的，一张事实表可能即是事务事实表又是无事实的事实表，但不可能即使是事务事实表又是周期快照事实表

### 事实表中的空值处理
事实表中允许空值的存在，因为sql中的sum、avg函数等可以对空置进行处理，但是对于事实表关联的维度外键不允许出现空值，否则事实表的完整性就受到了破坏。  

## 维度
维度是用来表达事件中事实产生的上下文环境。用于描述“谁、在哪、什么时候、如何、为什么”之类的事件背景。
比如还是上面的零售店内店员销售商品事件，其中销售额属于事实，那么销售额产生的环境：谁卖的：店员的员工工号、谁买的：顾客的姓名、在哪个店买的：零售店的名字、什么时候买的：顾客购买的时间，这些就是维度

### 如何区分事实与维度
通常情况可以用下面这个办法来简单的确定事件中的事实与维度
事实通常是数字型，事实对应的业务属性会有包含动词，比如销售金额、下单商品数量、付款金额等
维度通常是文本型，业务事件内的属性通常是一个名词，比如买家id、商品id等

## 维度表
维度表是事实表不可或缺的组成部分，维度表中存储的便是事件中事实发生的环境，也就是维度

### 维度表结构
每个维度表都包含单一的主键。维度表的主键是作为与之关联的事实表发生环境的外键。
维度表通常比较宽，是扁平化的反范式表，包含大量的低粒度的文本属性。  
维度表的属性是BI应用查询条件和分组的主要目标。

### 维度表主键的选择：自然键与代理键
#### 自然键
自然键是指在进入数据仓库之前，已经真实存在的主键  
比如：操作型系统传来的商品ID、用户ID
#### 代理键
代理键是指不是由操作型系统传来的主键，而是数据仓库系统自己生成的主键，代理键只有一个用途：关联事实表和维度表 
#### 维度表应当使用哪种主键
更推荐维度表使用代理键来作为主键，而不是操作型系统传来的主键，主要理由有两个:  
1. 代理键可以缓冲操作型系统的变化，使得数据仓库能确保对数据的控制。数据仓库中的数据来源于多个操作型系统，不同的操作型系统中可能会发生主键重复的问题，这时代理关键字可以解决这个问题。
2. 使用代理关键字可以建立一些真实环境中不存在的维度记录，例如“不在促销之列”，“日期待定”，“日期不可用”等维度记录。
2. 可以用于处理缓慢变化维，代理键的存在可以用来处理当维度表内的数据发生变化时，可以通过新增维度记录的方式来改变事实表记录的维度从而不删除变化前的维度记录  
3. 代理键可以使用尽可能小的数字递增键，对于数据庞大的事实表来说，它存储的关联维度表的键所消耗的空间就更小

### 为什么建议维度表使用反范式
使用第三范式来进行表设计的主要目的是减少数据的冗余，但是和事实表相比，维度表的数据会少得多，所以可以接受用冗余部分速度的代价换来好的查询性能以及更容易理解维度表，而不需要一次次的join才能理解一个维度表。这正好对应了维度建模的目标：简化和速度。所以对于维度表而言，使用反范式来扁平化维度可以使BI开发人员看表时更容易理解维度表，并且减少维度表之间的jion，提高性能。

### 退化维度
有时候，维度除了一个主键以外没有其他的内容，对于这种维度没必要额外建立一个维度表，而是退化到存储在事实表中，这个维度就是退化维度。  
比如订单事实表中的订单号这个维度，订单号是一个经常作为一个查询条件的维度，但是订单号这个维度只有订单号这个属性，我们就会将其直接存到事实表中，那么订单号就是一个退化维度。

### 维度表中的空置处理
对于维度表，不允许出现空值，如果维度中确实没有某些属性，应该用一些描述性的词来代替比如 unkonw,-1之类来表示不存在这个属性

## 如何处理维度表的变化
维度表并不是存储后一直不变的，会发生变化的维度也称为缓慢变化维。那么要如何处理缓慢变化维？
### 处理方式0：原样保留
原样保留就是当维度属性有新值时，直接丢弃，不进行处理  
这种方式通常用于要保留快照类型的维度属性
比如：用户维度表中，有一个属性是用户初始名，当这个属性要变化时，这个变化会被丢弃，维度表不发生任何改动  
### 处理方式1：重写
重写就是用新值覆盖到旧值。  
这种处理方式很简单，但是有一个使用前提，就是不关心数据的历史变化情况，因为这种方式会导致原值丢失，无法再获取到原来的数据是什么
### 处理方式2：增加新行
这种处理方式就是通过新增一行更新后数据来替代原来的旧数据  
这种处理方式需要维度表采用代理键的形式，以及维度表的行能表示当前行的有效时间。这样有新的事件发生时，事实表中记录的关联维度就可以根据事件发生的时间来关联新增维度的代理键（如果用自然键，所有事实表关联的维度表主键都是是一样的，无法区分真正关联的是什么时候的维度），事实表中旧的数据不受到维度更新的影响  

详细的处理方式：
1. 维度表行中增加 三个额外列 ：1：行有效的开始时间 2、行过期时间 3：当前行是否生效
2. 最初插入的维度记录中设置 1.行有效的开始时间就是插入时间 2.行过期时间用某个遥远日期表示不会过期 3.当前行有效
3. 当维度表发生变化时：  
  1. 上一条记录的过期时间更新为当前时间并改为失效
  2. 新增一条维度并设置 1.行有效时间为当前 2.行过期时间为不会过期 3.当前行有效
4. 后续事实表中插入的记录关联的就是新增的维度的代理键

![](./img/dimensional/%E7%BB%B4%E5%BA%A6%E5%8F%98%E5%8C%96%E7%9A%84%E5%A4%84%E7%90%86-%E7%B1%BB%E5%9E%8B2.png)
### 处理方式3：增加新属性
这种处理方式是在维度表上增加一个对应的新属性值用来保存原来的属性值，新的属性值则用处理方式1重写的形式到原来的属性；这种处理方式用的比较少，因为只能保留最近一个的数据变化历史
### 处理方式4：增加微型维度
这种处理方式是将多个不同的维度合范围并成一个小的维度行，当事实表插入新行时要到微型维度中寻找符合自身条件微型维度进行关联

这种处理方式的使用场景是如果维度属性的变化非常频繁，并且需要保留数据的变化情况，但是在分析时不太需要知道精准的维度属性，只需要知道维度处于什么某个范围即可。比较常见的就是年龄、年纪、月工资等这类变化频繁的属性。可以事先将这类属性可以预测的范围建立起微型维度  

![](./img/dimensional/%E5%BE%AE%E5%9E%8B%E7%BB%B4%E5%BA%A6.png)

还有一些其他处理方式是将上面几种处理方式混合使用，使用场景比较少，这里不做详细介绍，有兴趣可以自己书中原文


# 维度模型
## 星型模型  
星型模型是将事实表作为中心，事实表中只存储事实，相关的维度用关联的方式去关联维度表,维度表以扁平化的形式设计  
![](./img/dimensional/%E6%98%9F%E5%9E%8B%E6%A8%A1%E5%BC%8F.png)
## 雪花模型  
雪花模型也是将事实表作为中心，但是维度表则是以遵守第三范式的基础上进行设计，使得维度表看上去像雪花一样，我们应当尽量避免出现雪花模型，扁平化处理维度表。  
![](./img/dimensional/%E9%9B%AA%E8%8A%B1%E6%A8%A1%E5%9E%8B.png)
## 星座模型
星座模型是指随着星型模型的发展，维度表不只关联了一个事实表，被多个事实表贡献，使得表与表之间看起来像一个又一个的星座，星型模型必然会演化成星座模型
![](./img/dimensional/%E6%98%9F%E5%BA%A7%E6%A8%A1%E5%9E%8B.png)

# 维度建模4步骤
## 选择业务过程
业务过程是指公司完成的操作型事务。比如获得订单、处理保险索赔、学生课程注册。在进行维度建模时，我们最先做的就应该是选择哪些业来进行维度建模

## 声明粒度
声明粒度就是要精确的定义事实表的一行记录是什么。  
比如：  
- 零售店中销售事务里每个售出的产品作为事实表的一行
- 公司开出的票据里的内容作为事实表的一行  
- 仓库里的每种材料的库存情况的每日快照作为事实表的一行  
通常建议优先使用原子粒度，因为原子粒度不会丢失数据细节并且粒度的选择也会影响维度表是否详细，原子粒度所关联的维度也是最健壮的、最细节的，可以更好的满足对于查询、分析的需求。

## 确定维度
确定维度就是要表名我们要建立哪些维度表。用来解决”业务人员如何描述来自业务过程产生的事件”  
比较常见的维度：日期、产品、客户、设备等
## 确定事实 
确定事实用来确定业务过程中产生的事件中哪些内容用来作为事实，比较典型的事实是事件中的可加性数字  
比如销售金额、下单数量等


# 维度建模实践-零售商店

## 业务场景
假设我们工作在一个大型食品杂货连锁店，此连锁店由100个分布在5个不同的省份。每个商店都有完整的部门，包括杂货、冷冻食品、日常生活用品、肉类、农产品、烘烤商品、花卉、保健/美容产品等。每个商店包含被成为产品统一编号(SKU)的60000种不同的上架产品。

## 维度建模四步骤
### 选择业务过程
第一个步骤就是选择哪些业务过程来开展维度建模，在这个例子里 零售店的管理层想分析近期商店的售卖情况。因此我们选择的业务过程就是POS系统的零售交易（POS系统就是零售店员用来扫描产品以及和顾客交易的机器）  
### 声明粒度
对于粒度的选择，一般优先采用原子粒度，理由在上面。在零售交易中最细粒度是通过POS系统单个商品的卖出的记录，因此我们的事实表中一行存储的就是每个卖出去的商品。  

### 确定维度
粒度确定后，维度就比较容易选了。在这个案例中用来描述事实环境的维度有：日期、产品、门店、促销方式、收银员、支付方式

## 确定事实
最后一步，确定业务过程中产生的哪些事实要放入到事实表中。事实必须和上面声明的粒度吻合，比如在这个案例中事实的粒度是单个商品的卖出记录，那么我们不能将用户本次交易买的所有商品价格存入事实表中
这个案例中选择的事实：销售数量、单价、折扣、净价、扩展的美元销售额、扩展的总折扣额
- 扩展事实
可扩展事实，是指在既有的事实上通过后续的计算得到的事实。上面例子中的美元销售额就是一个扩展事实，通过销售数量x净价得到  ，扩展总折扣额则是销售数量x商品减免的价格
比如我们也可以通过销售额-商品的成本计算另外得到销售利润，销售利润是是我们后续计算所得，但是销售可以累加而且有分析价值，也可以将其作为事实存入到事实表中。  


## 事实表
根据上面声明的事务表粒度，我们建立了一张事务事实表  
![](./img/dimensional/%E9%94%80%E5%94%AE%E4%BA%8B%E5%AE%9E%E8%A1%A8.png)

## 维度表细节
下面介绍一下例子中各个维度表的详细情况
### 日期维度  
日期维度用来描述产品销售事件发生时的日期。
日期维度是一个特殊的维度，因为这个维度几乎会在所有维度建模中出现，每个业务过程都会含有日期型的描述信息。  
对于日期维度，我们可以事先现建立好十年、二十年的日期，并且日期维度可以不使用代理键，日期具有天然的递增下，可以直接采用以"yyyyMMdd"的形式作为主键。  
对于日期维度行内的属性，我们可以尽量详细的描述我们需要的日期标识，比如该天是周几、是否是特殊节日、是否是周末等等，详细的日期描述可以帮助我们更好的分析数据。比如我们要分析每个周末商店的销售额，如果日期中没有标识该天是否是周末，通过sql我们就无法做到这种分析。  
- 日期维度表结构
![](./img/dimensional/%E6%97%A5%E6%9C%9F%E7%BB%B4%E5%BA%A6%E8%A1%A8.png) 
- 日期维度表样例
![](./img/dimensional/%E6%97%A5%E6%9C%9F%E7%BB%B4%E5%BA%A6%E6%A0%B7%E4%BE%8B.png)  
## 产品维度
产品维度用来描述仓库中存储的每个SKU。
- 扁平化处理产品属性内的多对一情况
产品中的属性是我们这个案例中的主要分组目标，从sku上卷到品牌，品牌再上卷到类别之类。一个类别会有多个品牌、一个品牌下会有多个sku，这种情况我们选择将类别、品牌冗余至产品维度表，而不是再建立一个品牌维度、类别维度。  
- 产品维度表结构  

![](./img/dimensional/%E4%BA%A7%E5%93%81%E7%BB%B4%E5%BA%A6%E8%A1%A8.png)
- 产品维度表样例  

![](./img/dimensional/%E4%BA%A7%E5%93%81%E7%BB%B4%E5%BA%A6%E8%A1%A8%E6%A0%B7%E4%BE%8B.png)
## 商店维度
商店维度用来描述零售店连锁店的每个门店  
由于在POS系统中可能只有每次交易时的门店号，具体的门店信息可能在别的操作型系统中，这种情况下对于数据仓库开发人员来说必须从其他的操作型系统中获取到商店维度需要的各种信息。  
![](./img/dimensional/%E5%95%86%E5%93%81%E7%BB%B4%E5%BA%A6%E8%A1%A8.png)
## 促销维度
促销维度用来描述销售商品的促销活动。
促销维度是一种因果维度
 - 因果维度：  
 如果某个维度的变化会导致事实表变化，则称其为因果维度。每个维度（比如时间维度）的变化都会造成事实表（比如销售量）的变化，因果维度的特殊性在于这种变化是主动的，用来描述决策者行为对事实表的变化，而时间等维度更多的是自然性的变化。

促销活动包括临时降价、报纸广告、抵价券等，一个商品可能会同时采用多个促销活动所以。对于促销维度有两个选择：
1. 将所有促销活动组合成促销维度表的一行  
这样做的好处：  
- 合并成单一维度可以更方便观察三个促销活动之间的相互影响关系
2. 将促销活动按照类别分为多个促销维度表  
- 对于数据仓库的使用者来说在考虑不同的促销活动时，拆分为不同的维度会更容易理解
- 不同的维度表可能更好管理  
用上面两种方式建立维度表都可以，因为事实表本身存储内容在这两种方式下都是一样的，本次案例中使用的是第一种方式，将各个促销活动放到同一个维度表中  
- 促销维度表结构  
![](./img/dimensional/%E4%BF%83%E9%94%80%E7%BB%B4%E5%BA%A6%E8%A1%A8.png)

## 退化维度-事务号码
每次POS机交易时还有一个维度：事务号码，事务号码除了本身以外没有其他的信息，但是事务号码又经常做为一个查询条件，因此我们将其认为是一个退化维度，直接存储到事实表中，没有额外建立维度表

## 完整的维度模型结构  
至此，我们就建立完了这次销售事实的维度模型，整体结构如下图  
![](./img/dimensional/%E9%9B%B6%E5%94%AE%E4%BA%8B%E5%AE%9E%E7%BB%B4%E5%BA%A6%E6%A8%A1%E5%9E%8B.png)  
基于这个维度模型，我们可以很方便的通过SQL来计算每周的销售额、每个产品的销售情况等


## 开展促销活动事实表-无事实的事实表
上面的销售事实不能提供 “哪些产品有开展促销活动但是却没有销售出去” 这个信息，因为没有销售的产品并不在上面的事实表中，事实表无法记录没有发生的事件。如果要提供这个信息，我们可以再额外建立一个开展促销活动的事实表，这个事实表中记录了哪些商品开展了促销活动的事实。  

![](./img/dimensional/%E5%BC%80%E5%B1%95%E4%BF%83%E9%94%80%E4%BA%8B%E5%AE%9E%E8%A1%A8.png)  
在这个事实表中没有任何可以用来度量的事实，也就是一个无事实的事实表。  
（表中Promotion Count是一种为了便于计算而添加的虚拟事实，它是一个常量值，始终是1。存在的意义是如果我们要统计哪些商品在促销期间售卖的多少份，那么可以让我们避免对外键（产品维度的代理键）进行计数。）  
这样，当我们想知道“哪些产品有开展促销活动但是却没有销售出去”时，我们先到促销包含事实表中查询哪些商品开展了促销，然后在到销售事实表中查询哪些促销商品有售卖过，两者的差值就是我们要的结果。

# 小结
文章主要介绍维度建模的各种基本概念：事实、事实表、维度表等，以及一些事实表、维度表的处理技术。然后以零售商店作为例子，介绍如何实践维度建模，以及事实表、维度表是什么样子。
事实是某个业务结果的度量型数字。事实可以根据在某些维度是否可加下分为：可加事实、半可加事实、不可加事实  
维度是用于形容事实产生的背景环境：谁、什么时候、为什么等因素  
事实表存储的业务过程中发生的事件度量，以及关联的维度。事实表是维度建模的核心。  


| 参考资料:  
  《数据仓库工具箱》 1-3章